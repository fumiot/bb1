![FUMIOT](logo1.png)
---

# 概述
传统网络终端主要是手机电脑这样面向人的设备，人是网络的主要用户，网络把人们连结在一起。人们一直想要通过网络控制自己的物品，然而具备Wifi等联网能力的芯片长期以来在成本上无法满足开关这样的简单家用控制要求，直到2014年乐鑫发布esp8266芯片。它和类似的竞品器件迅速使得诸如灯/插座这样海量低价单品，可以通过互联网访问和控制。物联网正在迅速地渗入我们的日常生活。

局域网里面的两个网络节点，如连到一个热点的手机和设备，能够直接使用各自的本机IP地址互通，无需第三方节点的辅助。相对比，运营商提供的互联网则结构复杂，任意两个网络终端节点之间很难建立直接的网络连接。QQ钉钉等网络应用程序都会需要用户先连接并登录到一个公共的服务器，才能在终端用户之间互相通信。与之类似，物联网系统也需要一个相对集中的云端服务，用来给予每台物联网设备一个网络帐号，管理和维护物联网终端设备、所有者、应用系统之间的关联。在这个层面上，我们可以把物联网系统理解成一个让物品能够登录在线的即时通信系统，在这个系统中，物与物，物与人，物与应用系统之间近乎实时地交换信息，在互联网所及的范围之内，实现对物和过程的智能化感知、控制和管理。

物联网系统所依托的网络就是我们身边的互联网，相对传统网络应用，构建物联网系统的主要任务是设计实现设备端和云端服务。物联网设备端必须能够以远低于手机/电脑等网络终端的价格实现网络接入，否则无法达成足够广泛的场合覆盖。相对于手机/计算机的硬件平台标准化通用化程度，物联网设备的硬件更加多样化，资源紧凑，软件形态一般是嵌入式软件，开发难度相对较高。

这几年来，阿里、华为、腾讯等大厂都在物联网领域发力，构建了自己的物联网云平台，提供了设备端软件基础构架。

这些物联网公共云平台提供了比较低的接入门槛，开发者一般能够免费接入数十个物联网终端节点。

FUMIOT基于阿里的Alios Things开源嵌入式操作系统，完成了乐鑫ESP8266、ESP32，庆科EMW3060等不同硬件接入阿里云物联网平台的开发。为了促进物联网技术的应用和交流，我们将在下面讲解如何使用Alios Things+乐鑫WiFi Soc搭建物联网设备，接入阿里云物联网平台，实现物联网灯/插座和环境监测器，以及相关的手机APP和网页控制面板。[硬件设计CAD图和软件源代码](https://github.com/fumiot/bb1)均以在github开源，欢迎读者下载、反馈和参与改进。

# 目标与范围
结合可运行的系统级示例，讨论IoT系统架构、IoT开发环境、工具和调试技术、硬件接口技术、传感器应用、通信技术、RTOS、网络安全技术、测试验证、嵌入式开发技术、程序设计技术（构建之法，软件工程）等构建和维护物联网应用系统所需要的各种知识与技能。

建立一个整体可运行的物联网应用系统。包括实际的物联网设备硬件，物联网云平台服务，web应用，手机APP这几个部分的建立和互通。基于廉价（总价40元左右）易得的通用硬件模块，给出读者在1天时间内即可完成搭建和配置过程。


我们用一个具体的硬件平台，提供可直接烧录运行的固件，目的是在这么一个可运行的完整系统上，提供物联网系统的整体观，提供具体方面深入研究的代码级入口和系统级验证环境。为物联网应用开发提供一个系统级完整可运行的起点，基于这个起点，面向具体产品需要，可在各个方面深入。

可以作为大三的教科书，16至32学时的讲授与实验，学生能够了解物联网产品开发的各个方面，在工作中能够作为整体把控的参考，也能作为在具体某方面深入的入口，了解其他方面，与其他方面能够相互沟通和协调。


# 预期读者
高中以上即可按步骤搭建跑通示例。
可供物联网应用系统的产品经理，项目总体，嵌入式开发者，云端web应用开发者，手机APP开发者作为参考。
对于面向具体方面深入理解和定制需求，需要以下的具体技术基础：
设备端：单片机、C语言相关技术;
应用服务端：基于Java或Python的Web服务开发技术;
手机APP：Android（Java）、iOS（Objective-C）手机App开发。

# 免责声明

本文提供的内容、源代码是“原样”提供的，FUMIOT不对其使用或性能作出任何保证。其中包括任何明示的或默示的适销性、特别用途适用性或无知识产权侵权保证。FUMIOT不保证使用本文和相关软件所获的性能和结果。FUMIOT及其供应商不就任何事项做出保证、条件、陈述或条款（不论是明示的或默示的，无论是依据条例、普通法、惯例、常例，还是其他任何原因）包括但不限于不侵犯任何一方权利、适销性、完整性、满意的质量或适用于任何特殊用途。

# 版权

本文的版权协议为 [CC-BY-NC-ND license](https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh)。


# 1. IoT系统架构
IoT系统架构与传统的上位机+单片机构成的多机系统有相似之处。传统的多机系统一般由少量的通用计算机规模的中心节点和大量的单片机控制的设备终端节点构成，其通信网络一般是面向应用专门布设的有线或者无线网络，中心节点与终端节点之间可直接通信，终端节点之间通信交互较少或者没有。IoT系统在应用层面上看起来也是如此，大量的设备节点，少量的用户节点，用户使用功能较为强劲的终端设备，一般是手机或者电脑，通过相应的APP操作自己的IoT设备节点。


# 2. IoT应用开发
基于第一章所阐述的IoT系统架构，对于具体的IoT应用开发而言，IoT基础构件如芯片、云平台、设备端SDK等等一般可视为已有的基础设施，应用开发者需要了解相关技术特性和使用方法。应用开发工作主要涉及以下几个方面：
     1.系统设计
     2.结构设计
     3.硬件设计
     4.软件总体设计
     5.嵌入式软件设计
     6.云端开发
     7.APP开发
     
*对于学习者和爱好者，怎样才能好玩，不陷入为了盖一个狗窝，去建一个砖窑烧砖的窘境？答案就是在上述的各个方面选择成熟的社区开放平台，从易于搭建的完整示例出发，修改定制自己所需要的功能。智能开关+远程视频+下料器=宠物投喂器。
智能开关+温湿度传感器+水泵 = 远程浇花。*

主要的云平台、成熟的技术社区都提供了一些完整的系统级物联网应用示例。应该以这些示例为基础，学习研究物联网应用开发的方方面面。
本文提供的两个完整示例，相关步骤比较集中，建议读者按照步骤完整搭建。
其他网络文章提供的示例要么过于零碎，不能指望一篇短文搭建一个完整的物联网示例系统。云平台资源信息太庞杂，初学的时候容易迷失于海量的信息中，一不小心花费大量时间点了无数链接，最后却发现要找的答案就在回首灯火阑珊处。

# 3. 工具和调试
工欲善其事，必先利其器。物联网系统是软硬件综合的复杂系统，开发和部署等不同的阶段出现问题是难以避免的。这些问题的原因，硬件上有接触不良或者断裂的导线、虚焊、不一致的接口模式设置、损坏的IO端口等等；软件上有输入超限、未初始化的变量、字长不匹配，野指针等等。调试工具好比是医生的CT、超声波、手术刀与缝合线，利用这些工具，我们能够观察和理解系统的运行机理，发现问题之所在，建立问题的解决方案。

硬件工具：
昂贵的硬件仪表曾经是个人学习硬件技术的主要障碍，即便是最基础的示波器，动辄需要花费工薪阶层半年以上的积蓄。幸运的是，现在不到300元人民币就能获得足够一般的学习与产品开发所需的示波器和逻辑分析仪，这两样东西是理解和分析解决硬件问题的利器。
1. 烙铁焊锡等焊接工具
2. 万用表
检查电源电压，检查工作电流，检查缓慢变化的信号，测量pwm信号的均值。
4. 示波器
观察uart波形
5. 逻辑分析仪
观察i2c总线上的传感器数据，观察智能开关输出的控制电平，控制通断。

软件调试工具：
usb转uart串口
jtag仿真器，物联网设备主控制器一般具备jtag调试接口，需要打端点观察软件的内部状态时，开发计算机可以通过JTAG仿真器建立到物联网设备的调试连接，观察内部变量值，回溯调用栈分析软件问题。很多开发板内置了JTAG接口电路，用USB线连接电脑就能打断点调试了。在感兴趣的地方打上断点，一行一行单步跟踪软件源代码的执行，能够很好地帮助我们理解软件工作机理。

# 4. 硬件互联技术
*讨论数字电路的驱动、电平问题
讨论SPI，UART，I2C，并行总线等等的波形和时序，连接特性，选择考虑。*
物联网设备一般是一个典型的嵌入式系统，它由若干芯片（或模块），通过芯片（模块）之间的硬件接口互相连接。这些芯片有一个主控芯片，其他的有存储器、传感器、外部接口控制器等等，主控芯片一般使用自己的GPIO引脚连接一些按键和LED指示灯。
设计者需要正确接线，主控制器上运行的软件，需要配置通过这些接口，读写这些接口完成设备的整机功能。
设备内部的接口技术一般距离短、速度快、成本低，常用的内部接口有spi，i2c，ttl电平的uart；外部接口支持的距离相对较长，从几十厘米的USB、到数十米的以太网，到可达数千米的485，422，它们成本相对较高，有些技术的速度很低。

单个信号线的对接是连线的基础。对于芯片引脚，要么是是输入脚，要么是输出脚。双向引脚在某个特定的时刻也只能处于输入或者输出两者之一的一种模式。信号输入的输出均可简化为如下图所示的简单电路模型。输出这边有一个理想电压源和一个内阻，输入这边有一个负载电阻。一般速度的片间互联不用考虑容性和感性，按电阻考虑即可。使用这个简单的模型，使用初中物理的欧姆定律即可分析电路的工作特性。

*电路图*

数字信号的输出有三种模式，强（推挽），内部上拉，OC三种。其用途和特性各有不同，用上图模型，对照列表说明如下

输出模式  特性  用途   禁忌





存储器、传感器等芯片与主控芯片之间交互的信息量较多，会采用各种总线协议，使用时序逻辑脉冲传输较多的数据。

并行总线在机理上是最简单的，直接用1根物理信号线对应一个地址位或者数据位，其机理简单的代价就是要使用大量的信号线，16位系统就要16根地址线加上16根数据线，加上控制线，即使地址数据线复用仍然会有20根以上的信号线需要连接，给PCB布线带来困难。面包板（洞洞板）搭建原型时，接线更是噩梦一般，想想在面包板上，每个芯片都接上数十根线的样子吧。大量的连线，也使得板子的可靠性急剧下降，手工飞线的试验板很容易坏掉又难以修复。*此处可以配图,用洞洞板背面照片*

半导体器件集成度的提升，一方面降低了各种串行接口的成本，另一方面又保障了足够的传输速度。目前，单片机上普遍支持UART、SPI和I2C这几种串行接口，这些串行接口简单易用，易于调试，广泛用于传感器、存储器等芯片与MCU芯片之间的连接。

**问题导向，几个典型的连接关系，采用的连接方式，连线的对接，驱动和验证。**
## 4.1 UART
uart是各种物联网SoC以及其他单片机标配的接口。物联网设备一般至少有一个用于下载和输出调试信息的UART。最基本的uart有三根线，信号定义很直白，收、发、地。拿到两个具体的UART口，把它们对接连通则还有几个问题需要考虑和处理。
### 4. 1. 1电平
一个物理的UART接口，其逻辑1和逻辑0必然会映射到特定的电压（范围）。物联网SoC一般是3. 3V供电，引脚上用3. 3V左右表示逻辑1，0V左右表示逻辑0，其准确范围可参看具体芯片的规格表。其引脚一般不能直接连接来自5V系统的逻辑输出，误接会导致芯片的物理损坏。
例如现在的电脑多数没有外置的COM接口，我们常常会使用usb转串口小板，连接电脑和物联网设备开发板。USB转串口有RS232、5V、3. 3V等不同的规格，我们必须选用3.3V规格的才能接线到开发板上，错了就会搞不通甚至弄坏芯片。

### 4. 2. 2波特率等串口参数


### 4. 2. 3差分串口


## 4.2 SPI

## 4.3 I2C

*罗列*

# 5. 传感器
传感器把真实世界里的物理量、化学量或生物量等信息转换成微处理器能够读取和处理的电信号。

传感器的最前端是敏感元件，敏感元件利用某些材料或结构固有的物理、化学或生物效应，把被测的量转换成电压、电流等电学方面的量。有些敏感元件能够把相关物理量转换成电信号或电特性的变化，如光敏电阻、热敏电阻；有些敏感元件先把物理量转换成易于转换成电量值的其他中间物理量，如压力表首先把压力转换成弹片的形变，弹片的形变通过滑动变阻器再转换成电阻值的变化。

传感器最先转换出来的电信号一般是模拟信号，模拟电压或者电流的值与被测量的值有着一一对应的函数关系。通过模数转换（ADC）获得电信号的值，按这一函数关系即可计算出被测量的量值。由于元器件个体的差异，这一函数关系一般也有着个体差异，因此，传感器输出的原始模拟信号一般需要经过校准，才能正确推算实际的测量值。模拟接口的传感器需要连接微处理器的ADC引脚，微处理器上的软件需要完成相关的物理量测量函数转换和校准。

集成度更高的传感器芯片集成了模数转换和数字接口电路，微处理器使用SPI、I2C等数字接口就能够直接读取测量结果，电路和软件设计开发难度较之直接处理模拟信号大大降低，是构建物联网设备的首选。

# 6. 通信技术

物联网系统主要基于无线通信技术，最常用的就是Wifi和运营商提供4G、5G蜂窝网络。其他无线通信技术，如ZigBee、NFC等等，需要开发部署相应的网关设备接入物联网系统。

考虑通信范围、速率、可靠性、功耗等要素。


# 7. 嵌入式开发技术
硬件设计开发
原型验证、原理图、PCB图、硬件调试

软件设计开发
起始的最小系统、增量设计与开发、软件调试，多任务同步与等待

## 7.2 基本构件(参考alios things的各个模块，看图)
显示、按键、触摸屏、存储
应用开发

# 8. 物联网操作系统（RTOS）
物联网设备要实现TCP/IP网络协议栈，网络协议栈一般会涉及一些等待状态。设备也常常要求及时响应外部事件，同时运行多个流程上相对独立的任务。嵌入式软件最简单的前后台架构由若干中断服务程序和一个无限循环的主程序构成，主程序在每次循环中依次处理来自中断服务程序或者主动扫描到的外部事件。前后台架构没有多任务基础设施，难以满足物联网设备实现网络协议栈的需要，难以编写实现多任务的并发逻辑。单片机不部署RTOS的主要原因是存储空间和计算能力的不足，例如51只有64K的内存空间，处理的任务也相对简单，因此长期以来主要采用前后台架构构建软件。物联网SoC普遍基于32位处理器核，有数百K以上的RAM，程序Flash空间也是MB量级的，足够现代RTOS所需，因此物联网设备软件一般会基于存在RTOS的环境构建。

RTOS+物联网相关组件 = 物联网操作系统

基于RTOS的嵌入式软件一般会在main（）函数中
异步事件的等待问题，基础问题，网络协议栈会基于某RTOS具体实现。一些通信接口驱动具备阻塞式等待。

任务调度机制

堆、栈等内存管理与代码重入的问题

tickless 省电


# 9. 安全技术
威胁与对策
案例
安全能力：接入认证、防泄露、防伪指令。

传统的嵌入式设备在互联网上是不可见的，其安全性主要来自于其有限的物理边界。红外线遥控的空调、电视机，其控制范围就在红外信号可达的房间里，这样的
设备面临的安全威胁很小，也就是邻家顽童用自家的相同的遥控器，透过窗户给电视换个台调个音量罢了。

互联网则是一个开阔的安全大草原，黑客几乎是无孔不入。部署一个公网IP的服务器，观察其防火墙日志可见，几乎当天嗅探就会发现其存在，然后就有各样的攻击企图
接踵而来。物联网设备与这些服务器处于相同的网络环境中，网络安全是物联网系统需要妥善处置的关键问题之一。

失控的物联网设备可能造成的危害可大可小。小到灯泡被恶作剧地远程开关，大到大量物联网设备被控制成为肉鸡用来发起海量的DDOS攻击。案例，某网络摄像头厂家的
产品，存在漏洞被大量控制，黑客利用这些海量的节点发起DDOS攻击，导致xxx后果。

基于密码学的安全框架

应用事项：认证，设备密钥和设备证书的机制
        安全通信，SSL
          MQTT的安全。



# 10. 测试验证
单元测试、系统测试
测试用例的构建
变更的影响域分析和验证

基本的输入边界，传感器故障的问题的处理
网络事件的

确定测试用例，保证测试用例的覆盖性。软件并不能保证任何未经验证的处理能够正常运作，未得到考虑的事件能够正确处理。

还没讨论软件工程，这里只有系统测试。快萝卜不洗泥，后果是否能够承担。平衡测试的投入和产品的验证程度、资金和时间成本、市场迭代时限。底线是保证产品能够在市场上生存，用户愿意给予迭代改进的机会。



# 11. 程序设计技术（构建之法，软件工程）
麻雀虽小，五脏俱全。
童年时用砖块、木棍和油毡搭建的小屋（随意的即兴之作），宜家的拼装家具（标准化，易于构建），实用的房屋和大厦（复杂系统，必须依赖严格的工程流程）。



测试验证本是软件工程里面重要的一部分，前一节单独拎出来，是因为这个不可或缺，哪怕是拼乐高做个玩具都有。

# 12.构建示例应用
## 所需资源
### 硬件
物联网设备需要一个具备无线通信能力控制板，我们的控制板基于通用的ESP32核心板以面包板构建。对传感器等外设没有依赖的功能及demo可以直接在核心板上直接运行。

硬件设计目标是利用廉价易得的通用模块，构建便宜的硬件即可运行本书所构建的物联网应用系统例程。例程所用的硬件称为fumiot_bb1，原理图(链接)。fumiot_bb1能够用面包板轻松搭建，具备一个连接LED的GPIO输出，一个按键输入，可自选的温湿度传感器、加速度传感器、气压传感器等等。使用的NodeMCU-32S，自带一个接在GPIO0上的按键输入，一个接在GPIO2上的LED输出。
### 软件
本文用到的软件在github/fumiot。嵌入式软件基于alios-things构建，针对fumiot_bb1硬件进行了定制和修订。github/fumiot/Alios-Things直接可用。代码及本书均在github/fumiot/bb1.
Alios-thing迭代迅速，fumiot的目标之一是保持与其同步更新。截至2020年4月，bb1硬件支持的alios-things版本为v3.1.0。检查github/fumiot/bb1获取最新版本。
### 物联网云平台
aliyun，可免费部署50个测试节点。
正式产品接入费用可在物联网控制台中查看。
## 硬件搭建
当前的硬件配置：
|名称|价格|
|------|------|
|ESP32S核心板|20|
|SHT30温湿度传感器模块|13|
|杜邦线4股|1|
|总计|34|
可以加一个SSD1306的OLED做设备端显示，效果会更好一点。

无需工具，手工插接四根杜邦线即可。

面包板连线图片。

连好的面包板。

## 建立开发环境
开发环境的建立，有原生Linux系统最好，装Ubuntu 16.04就行了。Windows平台用docker下载安装好的镜像。
详细步骤

[Linux环境安装](https://help.aliyun.com/document_detail/161037.html?spm=a2c4g.11186623.4.1.10eb1c1eAt2rkl)

[Window环境安装](https://help.aliyun.com/document_detail/161038.html?spm=a2c4g.11186623.4.1.355e37e20nAwoy)

根据自己用的系统，选一种就行了，最后都是得到一个Linux环境，虚拟机或者物理实机，殊途同归。

安装步骤中，**编译**这一步面向庆科的mk3060创建了实例并编译，如果手头有
庆科mk3060开发板，可以按照庆科开发板的下载程序步骤，把helloworld烧写到板子里面，用串口工具查看输出的hello world。

Jlink仿真器步骤可选，需要打断点单步调试要用到相关设置。

### 本机编译验证
验证：hello world@linuxhost
### 面向esp32核心板编译、烧写验证：
hello world@esp32devkitc


## 注册云端资源
去阿里云的[生活物联网平台](https://living.aliyun.com/home)，点击开放平台入口，登录或者免费注册帐号。可以使用淘宝帐号，实名认证后就能开通物联网服务，创建项目和产品，在这里创建的产品，可以用的手机公版云智能app控制。
如下图：
![生活物联网平台首页](img/livingHome.png)

点击 “开放平台入口”，在下图中，注册阿里云帐号，也可使用淘宝帐号登录。

![生活物联网平台首页](img/loginYun.png)

获取物联网平台授权

![授权提示1](img/物联网平台授权.png)

![授权提示2](img/物联网平台授权2.png)

生活物联网平台有一个项目-产品-设备的层次结构，一个项目包括若干种产品，每种产品下可以创建若干具体设备的帐号。每个设备的在云平台上由*设备名称*，*设备密钥*，*产品名称*这个字符串唯一地标识，称为三元组，三元组加上*产品密钥*称为四元组。设备在登录云平台时要使用四元组，类似于人登录网络时的使用用户名和密码。
我们先点击“创建项目” 创建一个项目，后面的产品以及设备会在这个项目中创建。

![创建项目](img/CreateProject.png)


## WiFi智能插座
### 设备端
智能插座是典型的物联网应用，目前相关产品已经比较成熟，市场上的智能插座智能灯都是这类产品。我们会控制核心板上的LED，要实现对强电的控制，把LED对应的GPIO2接到继电器等驱动电路即可。
打开项目，创建产品，产品类目选择 “电工照明”-"插座"
![创建产品](img/outlet/创建插座.png)

点击完成，确认功能定义如下图所示，有“电源开关”，“故障上报”这两个必选项。

![功能定义](img/outlet/功能定义.png)

点击下一步，系统提示我们选择所用的模块，这里选ESP32-WROOM-32DC。这个选择实际上与具体实现所用的硬件没有直接绑定关系。选好模块后，出现了*设备调试*页面，在这里我们点击*新增测试设备*，调试阶段建议输入一个人易读的设备名称，不要让系统自动生成。创建设备的四元组，我们下面会直接用在源代码里面。当然，大量批产的实际产品不应把四元组写在源代码里面，应该是在生产阶段用某种方式写入每个设备。

![新增设备](img/outlet/新增设备.png)

到了这一步，我们就获得了连接阿里物联网云平台所需的四元组。

### 设备到云的连接
在源代码中，填入所获得的四元组
linkkit_example_solo.c的中，找到如下的四行处，将这四行的内容，分别换成上面新增设备获得的四元组的值：
```
#define PRODUCT_KEY      "a1FxISeKbq9"
#define PRODUCT_SECRET   "ThNbP5iNUQ1lQe2Q"
#define DEVICE_NAME      "alen-activate-test"
#define DEVICE_SECRET    "jcumDL5AJRgU7zRNcCcnHRiQmtii0vDn"
```

编译：
```
$ aos make
```
用手机数据线连接esp32，烧录固件：
```
aos upload
```
有些电脑需要手工按着板子上的IO0按键才能顺利进入烧录模式完成烧录。
用minicom打开一个串口终端，串口设置为115200 8N1，可以看见板子串口上输出的Log信息。

我们先使用串口控制台配网，连接 Wifi。
在minicom中，敲键盘回车，可以看见命令提示符#
输入命令：
netmgr connect WiFi热点名称 Wifi密码
输入回显可能会被输出的LOG信息打断，不用管它，正确地输入上面的命令，Enter，板子应能连接到Wifi热点，然后自动连接阿里云平台。minicom中能够看到这一过程输出的Log信息。
进入[物联网云平台](https://living.aliyun.com/home)，再次打开*设备调试*页，可以
看到设备在线，点击查看和调试可以看到设备更详细的云端状态信息和调试信息。按板子上的IO0按钮，可见板上灯切换亮灭状态，设备云端状态信息或者调试信息会同步更新。

![设备在线](img/outlet/设备在线.png)

至此，我们就完成了设备端的工作。

### Wifi配网
<span id="Wifi配网"></span>
多数物联网产品没有键盘和屏幕，如何把Wifi密码输入到设备是个问题，这就是WiFi配网。上例中，我们通过设备的调试串口，用电脑连线给设备输入了Wifi热点名称和密码，完成了Wifi配网，实际产品是不可能这样做的。下面为设备配置一键配网，使得用户可以通过手机扫二维码，在设备上按一下按键，给新设备Wifi配网。

进入[物联网云平台](https://living.aliyun.com/home)，再次打开*设备调试*页，点击*下一步：人机交互*

![人机交互](img/outlet/人机交互.png)
我们至少要完成*面板选择*、*分享方式*、*多语言管理*、*配网引导*这四项的设置。

点击*未设置*按钮，打开对应设置页面。在预定义面板中，选择一种合适的样式。

分享方式我们选定授权式，多语言管理中，在中文页面中填写品牌名称，产品名称，产品型号。

配网引导我们启用一键配网，关闭其他方式。
![配网引导](img/outlet/配网引导.png)

编辑引导页面，可修改手机app上显示的提示信息。
![配网提示信息](img/outlet/配网提示信息.png)

人机交互方式设置完毕后，手机就可以扫码下载云智能APP，使用云智能APP扫码对设备进行配网了。

### 手机APP控制设备

扫码配网成功后，可以打开选定的设备面板，对设备的状态进行控制，手机APP操作时，可以看见板上GPIO所连接的LED相应地切换亮灭状态。设备按键改变LED状态时，也可以看到手机APP显示的状态同步变化。手机界面如下图所示：
![ON](img/outlet/手机ON.jpg)
![OFF](img/outlet/手机OFF.jpg)

## 天猫精灵语音控制

### 其他开关单品

其他开关单品，设备端功能几乎相同，一般只需改改物模型的JSON对象名称，配置手机APP控制面板就行了。


## 环境监测

### 概述

Alios-things包括了许多传感器的驱动，我们在这里把一个i2c接口的SHT30温度传感器模块，挂接在ESP32的i2c总线上。接线表：

|SHT30|ESP32模块|
|------|------|
|VCC|3V3|
|GND|GND|
|SDA|P18|
|SCL|P19|

### 云端定义产品和创建设备

打开项目，创建产品，产品类目选择 “家居安防”-"温湿度采集单元"
![创建产品](img/envmon/envmon创建产品.png)

点击完成，添加*当前温度*和*当前湿度*这两个标准功能。
![添加功能](img/envmon/envmon添加功能.png)

确认产品功能定义如下图所示：

![功能定义](img/envmon/envmon功能定义.png)

点击下一步，选ESP32-WROOM-32DC模块。这个选择实际上与具体实现所用的硬件没有直接绑定关系。在*设备调试*页面，点击*新增测试设备*，获得测试设备的四元组。

### 设备到云的连接
在源代码中，填入所获得的四元组
linkkit_example_solo.c的中，找到如下的四行处，将这四行的内容，分别换成上面新增设备获得的四元组的值：
```
#define PRODUCT_KEY      "a1FxISeKbq9"
#define PRODUCT_SECRET   "ThNbP5iNUQ1lQe2Q"
#define DEVICE_NAME      "alen-activate-test"
#define DEVICE_SECRET    "jcumDL5AJRgU7zRNcCcnHRiQmtii0vDn"

编译：
```
$ aos make
```
用手机数据线连接esp32，烧录固件：
```
aos upload
```
有些电脑需要手工按着板子上的IO0按键才能顺利进入烧录模式完成烧录。
用minicom打开一个串口终端，串口设置为115200 8N1，可以看见板子串口上输出的Log信息。

我们先使用串口控制台配网，连接 Wifi。
在minicom中，敲键盘回车，可以看见命令提示符#
输入命令：
netmgr connect WiFi热点名称 Wifi密码
输入回显可能会被输出的LOG信息打断，不用管它，正确地输入上面的命令，Enter，板子应能连接到Wifi热点，然后自动连接阿里云平台。minicom中能够看到这一过程输出的Log信息。
进入[物联网云平台](https://living.aliyun.com/home)，再次打开*设备调试*页，可以
看到设备在线，点击查看和调试可以看到设备更详细的云端状态信息和调试信息。按板子上的IO0按钮，可见板上灯切换亮灭状态，设备云端状态信息或者调试信息会同步更新。

![在线调试](img/envmon/在线调试.png)

至此，我们就完成了设备端的工作。

## 公版云智能APP配网和访问

参照[智能插座Wifi配网](#Wifi配网)的步骤，可为设备配置启用公版云智能APP扫码配网和信息上显。
手机显示效果如下图所示：
![ON](img/envmon/手机显示1.jpg)
![OFF](img/envmon/手机显示2.jpg)

